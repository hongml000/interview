# js运行机制
##　如何理解js的单线程
* 进程： 描述了CPU在运行指令及加载和保存上下文所需的时间，放在应用上说就是一个程序。
* 线程： 是进程中的最小单位，描述了执行一段指令所需的时间。
一个进程可以有多个线程，比如渲染线程，JS引擎线程，http请求线程等。  
而我们常说JS是单线程的,说明它一个时间内只能干一件事，代码会顺序执行，容易出现代码阻塞。我们知道，JS运行的时候可能会阻塞渲染，说明两个线程是互斥的。因为在浏览器中，js主要是用来进行页面交互和操作页面的dom元素的，如果在js修改dom时，渲染线程还在工作，就可能导致不能安全的渲染。这也是js单线程的好处，可以节省内存，节约上下文切换时间，没有死锁的问题。

## 浏览器线程
竟然js是单线程执行的，那各种http请求和事件触发以及逻辑运行怎么可能执行的过来？其实不要混淆了，js线程一般只负责js的解析和执行。而上面说的请求和事件触发这些都是由浏览器处理的，而浏览器却是多线程的。一般的浏览器有以下几个线程：

* 事件触发线程：处理常见的DOM操作。
* 定时器线程：处理定时器任务，如setTimeout、setInterval。
* http请求线程：处理http请求。
* 渲染引擎线程：负责页面的渲染，当页面发生重绘和回流时会执行该线程。
* js引擎线程：负责js的解析和逻辑执行。  
我们所说的“js是单线程”指的就是浏览器一般只开一个js引擎线程来执行js。而在执行过程中遇到定时器或者http请求等，会丢给上面相对应的线程执行，而js则继续运行自己代码，这样就不会阻塞了，等到http请求或定时器等返回回调函数的时候且js引擎没有任务时（具体见下文），js再执行这个回调函数，这就是异步和回调。

当然js执行过程中不可避免也有比如复杂运算或多重循环等耗时操作，针对这个问题HTML5提出了Web Worker，它会在当前js执行主线程中利用Worker类新开辟一个额外的线程来加载和运行特定的JavaScript文件，这个新的线程和JavaScript的主线程互不干扰。同时HTML5也规定了 Web Worker中是不能操作DOM的，任何需要操作DOM的任务都需要委托给JavaScript主线程来执行，所以虽然引入HTML5 Web Worker，但仍然没有改变JavaScript单线程的本质。


## 什么是任务队列（执行栈）？

任务队列是一个存储函数调用的栈结构，遵循先进后出的原则。

## 浏览器中的event Loop（事件循环）
在js执行过程中，分为一个主执行栈和一个任务队列。js的代码执行会在执行栈中进行，遇到http请求或定时器等异步操作时，会将其丢给对应的线程去处理。每个异步任务都有一个回调函数，等到请求操作完成或定时器读秒完全后，才会放到任务队列中。当js主执行栈的内容为空时，会把对应的回调函数放入到执行栈中执行，等到函数执行完之后栈为空时，再来任务队列中取函数执行，如此反复循环直到任务队列和执行栈都为空，这就是事件循环机制event loop。  

ES6规范中，又将异步任务分为宏观任务和微观任务。
  * 宏观任务：比如定时器任务、网络请求、用户I/O
  * 微观任务：比如promise、nextTick
在执行栈为空时，会先读取所有微观任务，然后再读取一个宏观任务，再读取所有微观任务。如此反复循环，直至执行栈和任何队列都空为止。

## 面试题
### 下面例题的输出是什么？
```js
// 第1题 
console.log(1)
setTimeout(function() {
  console.log(2)
}, 0)
console.log(3)
// >>> 1， 3， 2
// 同步行打印1,3,再执行异步任务2

// 第2题
console.log('A')
while(true) {}
console.log('B')
// >>> A
// 同步行打印A,再同步执行while(true)，因为是个死循环，所以永远不会执行输出B


// 第3题
console.log('A')
setTimeout(function() {
  console.log('B')
}
while(1) {}
// >>> A
// 同步行打印A,将setTimeout异步任务先挂起，再同步执行while(1)，因为是个死循环，所以永远不会再执行到异步任务setTimeout输出B


// 第4题
for(var i=0; i<4; i++ ) {
  setTimeout(function() {
    console.log(i)
  }, 1000)
}
// >>> 4 4 4 4
```

解析： console.log是同步任务，setTimeout是异步任务；因为js是单线程的，当它执行同步任务时，如果遇到异步任务，会先将异步任务挂起，直到同步执行完毕后，才会执行异步任务

参考： 
https://www.jianshu.com/p/a15bdd1e75ba  
https://www.jianshu.com/p/4516ad4b3048